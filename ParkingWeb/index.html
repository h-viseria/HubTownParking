<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Allocation</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 120px);
            gap: 5px;
        }
        .cell {
            width: 120px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid black;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
        }
        .empty { background-color: green; color: white; }
        .occupied { background-color: white; color: red; }
        .hidden { display: none; }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid black;
            box-shadow: 2px 2px 10px gray;
        }
    </style>
</head>
<body>
    <h2>Parking Allocation</h2>
    <button onclick="initGIS()">Authorize</button>
    <div class="grid" id="parkingGrid"></div>

    <div id="parkPopup" class="popup hidden">
        <label>Wing:
            <select id="wingSelect" onchange="updateFlats()">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
        </label>
        <label>Flat:
            <select id="flatSelect"></select>
        </label>
        <button onclick="parkCar()">Park</button>
        <button onclick="closePopup()">Cancel</button>
    </div>

    <div id="emptyPopup" class="popup hidden">
        <p>Empty the parking slot?</p>
        <button onclick="emptySlot()">OK</button>
        <button onclick="closePopup()">Cancel</button>
    </div>

    <script>
        const CLIENT_ID = "231804756203-pon52d0g8l3arj4efscmedusaknankda.apps.googleusercontent.com"; // Replace with your Client ID
        const API_KEY = "AIzaSyBwG9LYoHMR2JXz0ANp83rBAl5K2LKds9w"; // Replace with your API Key
        const SHEET_ID = "12Va7yzdDhdp5NfSGXYrNtF6ZCHZxKq9gRnq0S9Xo0M8"; // Replace with your Google Sheet ID
        const RANGE = "Slots!A:B"; // Adjust based on your sheet structure
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
        let accessToken = "";
        let selectedSlot = null;

        function initGIS() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: "https://www.googleapis.com/auth/spreadsheets",
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        fetchParkingData();
                    }
                },
            }).requestAccessToken();
        }

        async function fetchParkingData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            try {
                const response = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
                const data = await response.json();
                updateGrid(data.values);
            } catch (error) {
                console.error("Error fetching parking data:", error);
            }
        }

        function updateGrid(values) {
            const grid = document.getElementById("parkingGrid");
            grid.innerHTML = "";
            const slots = generateParkingSlots();

            slots.forEach(slot => {
                const status = values.find(row => row[0] === slot)?.[1] || "Empty";
                const cell = document.createElement("div");
                cell.className = `cell ${status === "Empty" ? "empty" : "occupied"}`;
                cell.textContent = status === "Empty" ? slot : status;
                cell.onclick = () => handleCellClick(slot, status);
                grid.appendChild(cell);
            });
        }

        function generateParkingSlots() {
            let slots = [];
            for (let row = 1; row <= 7; row++) {
                let cols = row === 7 ? 4 : 3;
                for (let col = 1; col <= cols; col++) {
                    slots.push(`${row}0${col}`);
                }
            }
            return slots;
        }

        function handleCellClick(slot, status) {
            selectedSlot = slot;
            if (status === "Empty") {
                document.getElementById("parkPopup").classList.remove("hidden");
                updateFlats();
            } else {
                document.getElementById("emptyPopup").classList.remove("hidden");
            }
        }

        function updateFlats() {
            const wing = document.getElementById("wingSelect").value;
            const flatSelect = document.getElementById("flatSelect");
            flatSelect.innerHTML = "";

            let flats = [];
            if (wing === "A") {
                for (let i = 1; i <= 13; i++) {
                    flats.push(`${i}01`, `${i}02`);
                }
            } else if (wing === "B") {
                for (let i = 1; i <= 13; i++) {
                    flats.push(`${i}01`, `${i}02`, `${i}03`);
                }
            } else if (wing === "C") {
                for (let i = 1; i <= 8; i++) {
                    flats.push(`${i}01`, `${i}02`);
                }
            }
            flats.forEach(flat => {
                let option = document.createElement("option");
                option.value = flat;
                option.textContent = flat;
                flatSelect.appendChild(option);
            });
        }

        async function updateParking(slot, status) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?valueInputOption=RAW`;
            const body = { range: RANGE, majorDimension: "ROWS", values: [[slot, status]] };
            try {
                await fetch(url, {
                    method: "PUT",
                    headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });
                fetchParkingData();
            } catch (error) {
                console.error("Error updating parking data:", error);
            }
        }

        function parkCar() {
            const wing = document.getElementById("wingSelect").value;
            const flat = document.getElementById("flatSelect").value;
            updateParking(selectedSlot, `${wing}-${flat}`);
            closePopup();
        }

        function emptySlot() {
            updateParking(selectedSlot, "Empty");
            closePopup();
        }

        function closePopup() {
            document.getElementById("parkPopup").classList.add("hidden");
            document.getElementById("emptyPopup").classList.add("hidden");
        }
    </script>
</body>
</html>
